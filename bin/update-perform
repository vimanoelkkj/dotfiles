#!/bin/bash
source "$HOME/.local/share/dotfiles/bin/lib/helpers.sh"

clear
log_header "Updates"

if ask_yes_no "Update now?"; then
  log_step "Update started..."
elif [ $? -eq 130 ]; then
  exit 130
else
  log_info "Update canceled."
  exit
fi

# Cache sudo credentials for entire update process
sudo -v

log_step "Checking for git updates..."
if command -v update-git &>/dev/null; then
  update-git
else
  log_info "update-git command not found, skipping"
fi
echo

if command -v pacman &>/dev/null; then
  yay -Syu --noconfirm
else
  log_error "Platform not supported"
  exit 1
fi
echo

if command -v flatpak &>/dev/null; then
  log_step "Searching for Flatpak updates..."
  flatpak update
  echo
fi

orphans=$(pacman -Qtdq)
if [[ -n $orphans ]]; then
  log_step "Removing orphan system packages"
  for pkg in $orphans; do
    sudo pacman -Rs --noconfirm "$pkg" || true
  done
  log_success "Orphan packages removed"
else
  log_info "No orphan packages found"
fi
echo

# Reload
restart-app elephant
pkill -RTMIN+1 waybar
echo

if [ "$(uname -r | sed 's/-arch/\.arch/')" != "$(pacman -Q linux | awk '{print $2}')" ]; then
  log_info "Linux kernel has been updated."
  if ask_yes_no "Reboot now?"; then
    sudo reboot now
  fi
fi

# Finishing
show_done
exit 1
